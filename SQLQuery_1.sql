CREATE DATABASE DIALYVN

CREATE TABLE MIEN(
    MAMIEN CHAR(1) NOT NULL PRIMARY KEY CHECK(MAMIEN IN ('B','T','N')),
    TENMIEN VARCHAR(30) NOT NULL
);

CREATE TABLE TINH(
    MATINH CHAR(2) NOT NULL PRIMARY KEY,
    TENTINH CHAR(30) NOT NULL,
    DIENTICH INT CHECK(DIENTICH>0),
    DANSO INT CHECK(DANSO>0),
    THIXA CHAR(50),
    MAMIEN CHAR(1) FOREIGN KEY (MAMIEN) REFERENCES MIEN(MAMIEN),

);

CREATE TABLE NUOC(
    MANUOC CHAR(3) NOT NULL PRIMARY KEY,
    TENNUOC CHAR(30) NOT NULL,
    THUDO CHAR(50) NOT NULL
);

CREATE TABLE BIENGIOI(
    MATINH CHAR(2) NOT NULL,
    MANUOC CHAR(3) NOT NULL,
    CONSTRAINT KC_MATINH PRIMARY KEY (MATINH,MANUOC),
    CONSTRAINT KN_MATINH FOREIGN KEY (MATINH) REFERENCES TINH(MATINH),
    CONSTRAINT KN_MANUOC FOREIGN KEY (MANUOC) REFERENCES NUOC(MANUOC)
);

CREATE TABLE LANGGIENG(
    MATINH CHAR(2) NOT NULL,
    LG CHAR(2) NOT NULL,
    CONSTRAINT KG_LG PRIMARY KEY (MATINH,LG),
    CONSTRAINT RB_LG CHECK (MATINH<>LG),
    CONSTRAINT KN_MATINHLG FOREIGN KEY (MATINH) REFERENCES TINH(MATINH),
    CONSTRAINT KK_LG FOREIGN KEY (LG) REFERENCES TINH(MATINH)
);

INSERT INTO MIEN VALUES
('B','BAC'),
('T','TRUNG'),
('N','NAM');

INSERT INTO TINH VALUES
('AG','AN GIANG',3493,1812200,'LONG XUYEN','N'),
('BD','BINH DINH',4503,1420600,'QUY NHON','T'),
('BG','BINH DUONG',3859,590800,'THU DAU MOT','N'),
('BI','BINH THUAN',5345,786300,'PHAN THIET','T'),
('BL','BAC LIEU',4697,571500,'BAC LIEU','N'),
('BP','BINH PHUOC',6687,236500,'DONG XOAY','N'),
('BT','BEN TRE',2225,1184100,'BEN TRE','N'),
('CB','CAO BANG',8445,564400,'CAO BANG','B'),
('CM','CA MAU',2311,866100,'CA MAU','N'),
('CT','CAN THO',4126,1559300,'CAN THO','N'),
('DL','DAK LAK',11800,661000,'BAN ME THUOT','T'),
('DN','DONG NAI',7578,1741000,'BIENHOA','N'),
('DT','DONG THAP',3391,1335700,'CAO LANH','N'),
('GL','GIA LAI',25536,764200,'PLEIKE','T'),
('HB','HA BAC',4609,1929300,'HA BAC','B'),
('HT','HA TINH',9845,1300500,'HA TINH','T'),
('KG','KIEN GIANG',6358,1150500,'RACH GIA','N'),
('KH','KHANH HOA',3773,836700,'NHA TRANG','T'),
('LA','LONG AN',4355,1105300,'LONG AN','N'),
('LC','LAI CHAU',17068,387400,'LAI CHAU','B'),
('LD','LAM DONG',9933,511300,'DA LAT','T'),
('NA', 'NGHE AN', 12502, 2457600, 'VINH' , 'T'),
('NT','NINH THUAN',6374,495600,'PHAN RANG','T'),
('PY','PHU YEN ' , 6804 , 549700 , 'TUY HOA','T'),
('QB','QUANG BINH',7340,501800,'DONG HOI','T'),
('QN','QUANG NGAI',7900,967500,'QUANG NGAI','T'),
('QT','QUANG TRI',8555,603350,'DONG HA','T'),
('SG','TP HCM',2029,3667600,'SAI GON','N'),
('ST','SOC TRANG',2523,960400,'SOC TRANG','N'),
('TG','TIEN GIANG',2377,1399100,'MY THO','N'),
('TN','TAY NINH',4030,772500,'TAY NINH','N'),
('TT','THUA THIEN HUE',3123,100500,'HUE','T'),
('TV','TRA VINH',1732,836200,'TRA VINH','N'),
('VL','VINH LONG',2154,923600,'VINH LONG','N');


INSERT INTO NUOC VALUES
('CPC','CAMPUCHIA','PHNONG PENH'),
('LAO','LAO','VIEN CHAN'),
('TRQ','TRUNG QUOC','BAC KINH');

INSERT INTO BIENGIOI VALUES
('AG','CPC'),
('BP','CPC'),
('CB','TRQ'),
('DL','CPC'),
('DT','CPC'),
('GL','CPC'),
('GL','LAO'),
('HT','LAO'),
('KG','CPC'),
('LA','CPC'),
('LC','LAO'),
('LC','TRQ'),
('NA','LAO'),
('QB','LAO'),
('QT','LAO'),
('TN','CPC'),
('TT','LAO');


INSERT INTO LANGGIENG VALUES
('AG','DT'),
('AG','KG'),
('AG','CT'),
('BD','QN'),
('BD','PY'),
('BD','GL'),
('BG','SG'),
('BG','BP'),
('BG','DN'),
('BI','DN'),
('BI','NT'),
('BL','CM'),
('BL','ST'),
('BP','BG'),
('BP','DL'),
('BT','TG'),
('BT','TV'),
('CM','BL'),
('CT','AG'),
('CT','VL'),
('CT','TV'),
('CT','ST'),
('DL','BP'),
('DL','GL'),
('DL','KH'),
('DN','SG'),
('DN','BG'),
('DN','BI'),
('DN','LD'),
('DT','AG'),
('DT','TG'),
('DT','VL'),
('DT','LA'),
('GL','DL'),
('HT','NA'),
('HT','QB'),
('KG','AG'),
('KH','NT'),
('KH','PY'),
('LA','SG'),
('LA','TG'),
('LA','DT'),
('LD','DN'),
('LD','NT'),
('NA','HT'),
('NT','BI'),
('NT','LD'),
('NT','KH'),
('PY','KH'),
('PY','BD'),
('QB','HT'),
('QB','BD'),
('QN','BD'),
('QT','TT'),
('SG','LA'),
('SG','BG'),
('SG','TN'),
('SG','DN'),
('ST','CT'),
('ST','BL'),
('TG','DT'),
('TG','BT'),
('TG','SG'),
('TT','QT'),
('TV','VL'),
('VL','CT'),
('VL','DT'),
('VL','TV');
--1
SELECT TENTINH,DANSO 
FROM TINH
WHERE DIENTICH >=5000
--2
SELECT TENTINH,DIENTICH 
FROM TINH
WHERE MAMIEN='B'
--3
SELECT DISTINCT TENTINH 
FROM TINH, BIENGIOI, NUOC
WHERE TINH.MATINH=BIENGIOI.MATINH AND BIENGIOI.MANUOC=NUOC.MANUOC AND TENNUOC='LAO'
--3
SELECT TENTINH
FROM TINH INNER JOIN BIENGIOI ON TINH.MATINH = BIENGIOI.MATINH
WHERE MANUOC='LAO'
--4
SELECT TENTINH
FROM TINH
WHERE TENTINH = THIXA
--5
SELECT TENTINH
FROM TINH
WHERE DANSO/DIENTICH >=500
--6
SELECT TENTINH
FROM TINH
WHERE MAMIEN='T' AND DANSO>=1000000
--7
SELECT *
FROM TINH, BIENGIOI, NUOC
WHERE TINH.MATINH=BIENGIOI.MATINH AND NUOC.MANUOC=BIENGIOI.MANUOC AND THUDO='VIEN CHAN'
--8
SELECT TB=SUM(TINH.DIENTICH)/COUNT(TINH.MATINH)
FROM TINH
--9
SELECT DISTINCT TENNUOC, THUDO
FROM TINH,NUOC,BIENGIOI
WHERE NUOC.MANUOC=BIENGIOI.MANUOC AND BIENGIOI.MATINH=TINH.MATINH AND MAMIEN='N'
--10
SELECT TENTINH,THIXA,MD=(DANSO/DIENTICH)
FROM TINH
--11
SELECT TENTINH		
FROM TINH, LANGGIENG
WHERE LANGGIENG.MATINH=TINH.MATINH AND LG = 'LA'
--12
SELECT SoLuongTinh=COUNT(TINH.MATINH)
FROM TINH,BIENGIOI
WHERE TINH.MATINH=BIENGIOI.MATINH AND MANUOC='CPC'
--13
SELECT TINH.MATINH,TENTINH,THIXA
FROM TINH,LANGGIENG
WHERE TINH.MATINH=LANGGIENG.MATINH
GROUP BY TINH.MATINH,TENTINH,THIXA
HAVING COUNT(LG)>3
--14
SELECT TENTINH
FROM TINH
WHERE DIENTICH IN (
SELECT MAX(DIENTICH)
FROM TINH
)
--15
SELECT TOP(3) MATINH,TENTINH,THIXA
FROM TINH
ORDER BY DANSO DESC
--16
SELECT MATINH, TENTINH, DIENTICH, DANSO
FROM TINH
WHERE DIENTICH < (SELECT DIENTICH
		FROM TINH
		WHERE TENTINH = 'LONG AN')
AND DANSO > (	SELECT DANSO
		FROM TINH
		WHERE TENTINH = 'LONG AN')
--17
 --CAU 17
SELECT TENTINH
FROM TINH INNER JOIN BIENGIOI ON TINH.MATINH = BIENGIOI.MATINH
GROUP BY TENTINH
HAVING COUNT(MANUOC) = 2
--18
SELECT TENTINH
FROM TINH
WHERE MATINH NOT IN (
		SELECT MATINH
		FROM BIENGIOI
)
--19
SELECT MIEN.TENMIEN,TENTINH
FROM TINH INNER JOIN MIEN ON TINH.MAMIEN = MIEN.MAMIEN
GROUP BY MIEN.TENMIEN,TENTINH

--CAU 20
SELECT TENTINH, COUNT(LG) AS SOLANGGIENG
FROM TINH INNER JOIN LANGGIENG ON TINH.MATINH = LANGGIENG.MATINH
GROUP BY TINH.TENTINH
HAVING COUNT(LG) = (
	SELECT MAX(SOLANGGIENG)
	FROM(
		SELECT COUNT(LG) AS SOLANGGIENG
		FROM TINH INNER JOIN LANGGIENG ON TINH.MATINH = LANGGIENG.MATINH
		GROUP BY TINH.TENTINH)AS TMP)


--CAU 21
SELECT TENTINH
FROM TINH
WHERE DANSO > 2 * (SELECT DANSO FROM TINH WHERE TENTINH = 'QUANG TRI')

--CAU 22
SELECT TENTINH, DIENTICH
FROM TINH
WHERE DIENTICH <
	(SELECT AVG(DIENTICH)
	FROM TINH)
--CAU 23
SELECT TENMIEN, SUM(DANSO) as TONGDANSO
FROM TINH INNER JOIN MIEN ON TINH.MAMIEN = MIEN.MAMIEN
GROUP BY TENMIEN
ORDER BY TONGDANSO DESC

--CAU 24
SELECT TENMIEN, SUM(DANSO) / SUM(DIENTICH) AS MATDO
FROM TINH INNER JOIN MIEN ON TINH.MAMIEN = MIEN.MAMIEN
GROUP BY TENMIEN
ORDER BY MATDO DESC

--CAU 25
SELECT MATINH, TENTINH, THIXA, DANSO / DIENTICH AS MATDO
FROM TINH
WHERE DANSO / DIENTICH > (SELECT SUM(DANSO) / SUM(DIENTICH) FROM TINH)

--CAU 26
SELECT TENTINH
FROM TINH INNER JOIN BIENGIOI ON TINH.MATINH = BIENGIOI.MATINH, NUOC
WHERE TENNUOC = 'CAMPUCHIA' AND TENTINH IN
	(SELECT TENTINH
	FROM TINH INNER JOIN LANGGIENG ON TINH.MATINH = LANGGIENG.MATINH
	GROUP BY TENTINH
	HAVING COUNT(LG) = 3)

--CAU 27
SELECT DISTINCT TENTINH
FROM TINH INNER JOIN LANGGIENG ON TINH.MATINH = LANGGIENG.MATINH
WHERE LG IN (
	SELECT MATINH
	FROM TINH INNER JOIN MIEN ON TINH.MAMIEN = MIEN.MAMIEN 
	WHERE TENMIEN = 'TRUNG')
	
INTERSECT 

SELECT DISTINCT TENTINH
FROM TINH INNER JOIN LANGGIENG ON TINH.MATINH = LANGGIENG.MATINH
WHERE LG NOT IN (
	SELECT MATINH
	FROM TINH INNER JOIN MIEN ON TINH.MAMIEN = MIEN.MAMIEN 
	WHERE TENMIEN = 'TRUNG')

--CAU 28
SELECT TINH.MATINH, TENTINH
FROM TINH
WHERE MATINH IN (
	SELECT LG
	FROM TINH INNER JOIN LANGGIENG ON TINH.MATINH = LANGGIENG.MATINH
	WHERE TINH.TENTINH = 'TP HCM') 
AND MATINH NOT IN 
	(SELECT MATINH
	FROM BIENGIOI INNER JOIN NUOC ON BIENGIOI.MANUOC = NUOC.MANUOC
	WHERE TENNUOC = 'CAMPUCHIA')

--CAU 29
SELECT TENTINH
FROM TINH
WHERE MATINH IN (
	SELECT LG
	FROM LANGGIENG INNER JOIN TINH ON TINH.MATINH = LANGGIENG.MATINH
	WHERE TINH.MATINH IN
			(SELECT LG
			FROM LANGGIENG INNER JOIN TINH ON TINH.MATINH = LANGGIENG.MATINH
			WHERE TINH.TENTINH = 'TP HCM')
)
AND TENTINH != 'TP HCM'

--CAU 30
SELECT DISTINCT TENNUOC
FROM BIENGIOI INNER JOIN NUOC ON BIENGIOI.MANUOC = NUOC.MANUOC
WHERE MATINH IN
	(SELECT LG
	FROM LANGGIENG INNER JOIN TINH ON TINH.MATINH = LANGGIENG.MATINH
	WHERE TINH.TENTINH = 'DAK LAK')
